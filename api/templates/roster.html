{% extends "base.html" %}

{% block head %}
{{ super() }}
    {% include "map_head.html" %}

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<style>
    .col {
        margin: 10px;
        background: aqua;
        border: 1px solid black;
        border-radius: 10px;
    }

    table.dataTable {
        border: 1px solid black;
        border-radius: 7px;
    }

    table.dataTable tbody tr:hover {
        background-color: #eee;
    }
    table.dataTable td {
        font-size: 8pt;
    }

    .rowbutton {
             appearance: none;
             /*background-color: #2ea44f;*/
             border: 1px solid rgba(27, 31, 35, .15);
             border-radius: 6px;
             box-shadow: rgba(27, 31, 35, .1) 0 1px 0;
             box-sizing: border-box;
             color: #fff;
             cursor: pointer;
             display: inline-block;
             font-family: -apple-system,system-ui,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
             font-size: 10px;
             font-weight: 600;
             line-height: 10px;
             margin: 1px;
             padding: 6px 16px;
             position: relative;
             text-align: center;
             text-decoration: none;
             user-select: none;
             -webkit-user-select: none;
             touch-action: manipulation;
             vertical-align: middle;
             white-space: nowrap;
         }

    .rowbutton:focus:not(:focus-visible):not(.focus-visible) {
        box-shadow: none;
        outline: none;
    }

    .rowbutton:hover {
        background-color: #2c974b;
    }

    .rowbutton:focus {
        box-shadow: rgba(46, 164, 79, .4) 0 0 0 3px;
        outline: none;
    }

    .graph_overlay {
        position: absolute;
        visibility: hidden;
        top: 10%;
        left: 10%;
        width: 50%;
        height: 50%;
        /*background-color: rgba(0, 0, 0, 0.5);*/
        z-index: 1000;
    }
</style>
{% endblock %}


{% block content %}
    <div class="graph_overlay">
        <div id="graph"></div>
    </div>

    <div class="row">
        <div class="col">
            <h3>Team</h3>
            <div id="valid_team">Valid Team: </div>
            <div id="valid_lineup">Valid Lineup: </div>
        </div>
        <div class="col">
            <h3>Score</h3>
            <button id="calculate_score">Calculate Score</button>
            <div id="score"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <table class="display compact" id="assets">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Source</th>
                    <th>Action</th>
                </tr>
                </thead>
            </table>
        </div>
        <div class="col-lg-4">
            {% include "map_include.html" %}
        </div>
    </div>
{#    <div class="row">#}
{#        <div class="col" style="visibility: ">#}
{#            <h3>Graph</h3>#}
{#            <div id="graph" style="visibility: hidden"></div>#}
{#        </div>#}
{#    </div>#}

<script>

    function do_validation(){
        fetch('/api/{{version}}/roster/{{ roster_slug }}/validate').then(
            response => response.json()
        ).then(data => {
            $('#valid_team').html('Valid Team: '+data.team)
            $('#valid_lineup').html('Valid Lineup: '+data.lineup)
        })
    }
    function indexOfMaximumValue(my_array) {
        if (my_array.length === 0) {
            return -1;
        }
        else{
            var maximumValue = my_array[0];
            var maxIndex = 0;

            for (var i = 1; i < my_array.length; i++) {
                if (my_array[i] > maximumValue) {
                    maxIndex = i;
                    maximumValue = my_array[i];
                }
            }
            return maxIndex;
        }
    }


    $(document).ready(function () {

        do_validation()

        const tokenurl = window.location.origin+'/mapboxtoken'
        fetch(tokenurl)
            .then(response => response.json())
            .then(data => {
                mapboxgl.accessToken = data.token;
                const map = initMap([-106.5, 34.5], 6, '/api/v1/roster/{{ roster_slug }}/geojson');

                $('#assets').on('click', '#view_map', function () {
                    console.log('asdfasfadsfsd afasdfafas')
                    var table = $('#assets').DataTable();
                    var selected_asset = table.row($(this).parents('tr')).data();
                    map.jumpTo({center: [selected_asset.longitude, selected_asset.latitude], zoom: 13});
                });


            });

        // make graph
        Plotly.newPlot('graph', [], {});

        // handle calculate score button
        $('#calculate_score').click(function () {
            fetch('/api/{{version}}/roster/{{ roster_slug }}/validate').then(
                response => response.json()
            ).then(data => {
                if (data.lineup){
                    fetch('/api/{{version}}/roster/{{ roster_slug }}/score').then(
                        response => response.json()
                    ).then(data => {
                        $('#score').html('Points: '+data.score)
                    })
                }
            })
        })

        // make asset table
        $('#assets').DataTable({
                "ajax": {
                    "url": "/api/{{ version }}/roster/{{ roster_slug }}",
                    "dataSrc": ""
                },
                "info": false,
                "paging": false,
                "pageLength": 25,
                "searching": false,
                "createdRow": (row, data, dataIndex, cells) => {
                    $(row).css('background-color', data.active ? '#64b976': '#b07d6e')
                },
                "columns": [
                    {"data": "slug"},
                    {"data": "atype"},
                    {"data": "source_slug"},
                    {"data": null,
                        "defaultContent":
                            "<button style='background: #2c974b' class=rowbutton id=make_active>Active</button>"+
                            "<button style='background: #c24850' class=rowbutton id=make_inactive>Inactive</button>"+
                            "<button style='background: #6b82d9' class=rowbutton id=view_graph>Graph</button>"+
                            "<button style='background: #0b82d9' class=rowbutton id=view_map>Map</button>"
                    }
                ]
            });


            function toggle_active(table, selected_asset, state){
                console.log(selected_asset);
                fetch('/api/{{version}}/roster/{{ roster_slug }}/'+selected_asset.slug,
                    { method: 'PUT',
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({'active': state})
                    }
                ).then(
                    response => response.json()
                ).then(data => {
                    console.log(data)
                    table.ajax.reload()

                    do_validation()
                })
            }

            $('#assets').on('click', '#make_active', function () {
                var table = $('#assets').DataTable();
                var selected_asset = table.row($(this).parents('tr')).data();
                toggle_active(table, selected_asset, true)
            });

            $('#assets').on('click', '#make_inactive', function () {
                var table = $('#assets').DataTable();
                var selected_asset = table.row($(this).parents('tr')).data();
                toggle_active(table, selected_asset, false)
            });

            $('.graph_overlay').click(function () {
                $(this).css('visibility', 'hidden')
            })

            $('#assets').on( 'click', '#view_graph', function (e) {

                var table = $('#assets').DataTable();
                var selected_asset = table.row($(this).parents('tr')).data();


                //graph the data for this asset
                fetch('/api/{{version}}/asset/'+selected_asset.slug+'/data_url').then(
                    response => response.json()
                ).then(data=>{
                    fetch(data.prev_url).then(
                        response => response.json()
                    ).then(data =>{

                        var values = data["value"]['timeSeries'][0]['values'][0]['value']

                        var y = values.map(v=>v['value'])
                        var x = values.map(v=>v['dateTime'])

                        var trace1 = {
                            x: x,
                            y: y,
                            mode: 'lines',
                            name: 'timeseries'
                        };

                        var trace2 = {
                            x: [x[0], x[x.length-1]],
                            y: [y[0], y[0]],
                            mode: 'lines',
                            name: 'baseline'
                        };

                        var xmax = indexOfMaximumValue(y)
                        console.log(xmax, x[xmax], Math.max(...y))
                        var trace3 = {
                            x: [x[xmax], x[xmax]],
                            y: [Math.max(...y), Math.min(...y)],
                            mode: 'lines',
                            name: 'max'
                        };
                        Plotly.react('graph',
                            [trace1,trace2,trace3], {'title': selected_asset.name + ' -- ' +
                                    selected_asset.source_slug});
                        $(".graph_overlay").css('visibility', 'visible');

                    })
                })

            } );

    })
</script>
{% endblock %}