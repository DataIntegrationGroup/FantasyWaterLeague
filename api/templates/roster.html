{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<style>
    .col {
        margin: 10px;
        background: aqua;
        border: 1px solid black;
        border-radius: 10px;
    }
</style>
{% endblock %}


{% block content %}
<div class="row">
    <h1>Roster</h1>
    <table class="display compact" id="assets">
        <thead>
            <tr>
                <th>slug</th>
                <th>atype</th>
                <th>source_slug</th>
            </tr>
        </thead>
    </table>
</div>
<div class="row">
    <div class="col">
        <h3>Score</h3>
        <div id="score"></div>
    </div>
</div>

<div class="row">
    <div class="col">
        <h3>Graph</h3>
        <div id="graph"></div>
    </div>
</div>

<script>
    $(document).ready(function () {
            $('#assets').DataTable({
                "ajax": {
                    "url": "/api/{{ version }}/roster/{{ roster_slug }}",
                    "dataSrc": ""
                },
                "columns": [
                    {"data": "slug"},
                    {"data": "atype"},
                    {"data": "source_slug"},

                ]
            });
            Plotly.newPlot('graph', [], {});


            $('#assets').on( 'click', 'tbody td', function () {
                var table = $('#assets').DataTable();
                var selected_asset = table.row( this ).data();

                fetch('/api/{{version}}/asset/'+selected_asset.slug+'/score').then(
                    response => response.json()
                ).then(data => {
                    $('#score').html('Points: '+data.score)
                })

                //graph the data for this asset
                fetch('/api/{{version}}/asset/'+selected_asset.slug+'/data_url').then(
                    response => response.json()
                ).then(data=>{
                    fetch(data.url).then(
                        response => response.json()
                    ).then(data =>{

                        var values = data["value"]['timeSeries'][0]['values'][0]['value']

                        var trace1 = {
                            x: values.map(v=>v['dateTime']),
                            y: values.map(v=>v['value']),
                            mode: 'lines',
                            name: 'lines'
                        };

                        Plotly.react('graph', [trace1], {'title': selected_asset.source_slug});
                    })
                })

            } );

    })
</script>
{% endblock %}